# 自動時刻調整

candy-pi-liteサービスを利用すると、インターネット通信をこなわずに時刻の調整を行うことができます。これにより、ntp通信のためのパケットを抑制したり、インターネットに接続しない閉域網であってもラズパイの時刻を合わせることができるようになります。

## ntpを使わない時刻同期

ラズパイの標準的なOS「Raspbian（ラズビアン）」には、通常ntpと呼ばれる時刻同期サービスが動作しています。このサービスにより、インターネット上のntpサーバーと呼ばれる時刻管理用のサーバーと交信してラズパイの時刻の調整を行なっています。

ntpは、ntpサーバーとの通信をUDPで行なっているので、3G/LTE通信モジュールを利用してインターネットに接続した場合、UDPパケットの通信が発生します。また、ntpサーバーのアドレスが名前で示されている場合は、その名前の解決にDNSが利用され、その部分でも通信パケットが発生します。このため、不要な通信を行いたくない場合であっても、時刻調整のためにntpサービスを動かしていると、一定時間ごとに時刻同期のための通信が発生しています。

一方、3G/LTE通信モジュールは、それ自体に時刻を管理する仕組みを持っています。また、最新の時刻を携帯電話ネットワークから取得することもできます。このため、3G/LTE通信モジュールの機能を利用すれば、ntpを利用せずとも時刻の調整を行うことができるのです。

インターネットに接続せずに時刻を同期できる利点は他にもあります。閉域網と呼ばれる固有のネットワーク設定を行った環境へ携帯電話ネットワークで接続する場合でも、その環境にntpサーバーを置く必要もなく時刻の同期をおこなるようになります。

## 時刻調整の精度

candy-pi-liteサービスは、シリアル通信を介して3G/LTE通信モジュールから時刻を取得します。また、その時刻は、秒単位までの精度しか持っていません。このため、通信や処理の遅延や誤差を考慮すると1秒前後のずれが生じます。このずれは、ntpで同期を行う場合よりも大きいと考えられるので、精度に関してはntpよりも不利な面もあります。

candy-pi-liteサービスは、このずれの解消のため1秒の補正を行っています。この1秒の値は、必要に応じて利用者の方が変更することも可能です。時刻の補正は、携帯電話のネットワークへ接続する前に行われます。

## 時刻調整スケジュール

USB接続を利用せずに3G/LTE通信を行っているときは、時刻調整を行うために定期的に携帯電話ネットワークからの切断と再接続を行う必要があります。これは、モデム通信のシリアルポートがPPP接続と呼ばれるデータ転送通信に占有されてしまい、それ以外の通信ができなくなっているためです。

利用者の方は、candy-pi-liteサービスが定期的な切断と再接続を行うためのスケジュールを指定することができるようになっています。初期設定では、このようなスケジュールは設定されていません。

## 3G通信における時刻調整

candy-pi-liteサービスは、NTPを使わずに時刻同期を行う場合、通常の3G通信の前に5秒程度の短い3G通信の接続を行います。これは、3G通信モジュールが3G通信が確立してから初めて時刻の情報を得られるためです。LTE通信モジュールの場合は、3G通信とは別の仕組みで実現されているため、このような手順を踏まずとも時刻同期を行えるようになっています。

なお、時刻同期は携帯電話ネットワークオペレーター（通信キャリア）が提供する機能であるため、日本国外の携帯電話ネットワークオペレーターでは携帯電話ネットワークを用いた時刻同期ができない場合もあるかもしれません。
